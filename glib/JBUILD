name="glib"
version="2.84.4"
url="https://download.gnome.org/sources/glib/2.84/glib-2.84.4.tar.xz"
md5="5655d0ff809b98dd77c02490609fadde"
deps=("libxslt" "docutils" "pcre2" "wget")

prepare() {
    wget https://download.gnome.org/sources/gobject-introspection/1.84/gobject-introspection-1.84.0.tar.xz
    echo "2a62fb1c584616a8ebcd9dd4d045f27e  gobject-introspection-1.84.0.tar.xz" | md5sum -c - || exit 1
    tar xf gobject-introspection-1.84.0.tar.xz
    patch -Np1 -i ../glib-skip_warnings-1.patch
    if [ -e /usr/include/glib-2.0 ]; then
        rm -rf /usr/include/glib-2.0.old &&
        mv -vf /usr/include/glib-2.0{,.old}
    fi
}

build() {
    mkdir build &&
    cd    build &&

    meson setup ..                  \
          --prefix=/usr             \
          --buildtype=release       \
          -D introspection=disabled \
          -D glib_debug=disabled    \
          -D man-pages=enabled      \
          -D sysprof=disabled       &&
    ninja
}

package() {
    # 1. Install initial GLib
    DESTDIR="$DESTDIR" ninja install
    # 2. Build and Install G-I into the staging directory
    tar xf ../gobject-introspection-1.84.0.tar.xz
    meson setup gobject-introspection-1.84.0 gi-build \
                --prefix=/usr --buildtype=release || exit 1
    ninja -C gi-build || exit 1
    DESTDIR="$DESTDIR" ninja -C gi-build install || exit 1
    # --- THE CRITICAL ENVIRONMENT FIX ---
    
    export PATH="$DESTDIR/usr/bin:$PATH"
    export PKG_CONFIG_PATH="$DESTDIR/usr/lib/pkgconfig:$DESTDIR/usr/lib64/pkgconfig:$DESTDIR/usr/share/pkgconfig:$PKG_CONFIG_PATH"
    export PKG_CONFIG_SYSROOT_DIR="$DESTDIR"
    export LD_LIBRARY_PATH="$DESTDIR/usr/lib:$DESTDIR/usr/lib64:$LD_LIBRARY_PATH"
    
    # Python needs to find the 'giscanner' module inside staging
    # Use 'python3 -c "import sys; print(f\"{sys.version_info.major}.{sys.version_info.minor}\")"' 
    # if you want to be dynamic, but 3.13 is likely correct for your LFS.
    export PYTHONPATH="$DESTDIR/usr/lib/python3.13/site-packages"
    
    # Introspection needs to find the base typelibs inside staging
    export GI_TYPELIB_PATH="$DESTDIR/usr/lib/girepository-1.0"
    # --- RECONFIGURE AND REBUILD ---
    
    # Use 'configure' to update options in the existing build directory
    meson configure -Dintrospection=enabled &&
    ninja &&
    DESTDIR="$DESTDIR" ninja install
}
